name: Nagios Build
# This workflow is triggered on pushes to the repository.
# Taken from tutorial
# https://github.com/gitschooldude/hello
# https://www.youtube.com/watch?v=-xIXFxuZCMI
on: [push]

jobs:
  build-and-run:
    name: Build image and deploy to DockerHub
    runs-on: ubuntu-latest
    env:
      DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
      DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      DOCKER_PLATFORMS: 'linux/amd64 linux/arm/v6 linux/arm/v7'
      DOCKER_BASE: 'manios/nagios'
      TAGS: 'energeia'
    steps:
      - uses: actions/checkout@v1
      - name: Set permissions
        run: chmod 744 multi-arch-docker-ci.sh
      - name: Build first stage image
        env:
          TAGS: 'builder-base'
        run: |
          source ./multi-arch-docker-ci.sh
          set -ex
          multi_arch_docker::printvars
          multi_arch_docker::install_docker_buildx
          multi_arch_docker::login_to_docker_hub
          multi_arch_docker::printvars
          echo "Tags are $TAGS"
          set +x
      - name: Build builder-base image
        env:
          TAGS: 'builder-base'      
        run: |
          echo "===================================="
          echo "==== Build stage $TAGS ===="
          echo "===================================="
          docker pull "manios/nagios:$TAGS-linux-amd64" || true
          docker pull "manios/nagios:$TAGS-linux-arm-v6" || true
          docker pull "manios/nagios:$TAGS-linux-arm-v7" || true
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          PLATFORM_DASH="linux-amd64"
          docker build --platform="linux/amd64" \
            --build-arg PLATFORM_DASH="$PLATFORM_DASH" \
            --target "$TAGS" \
            --cache-from="manios/nagios:$TAGS-$PLATFORM_DASH" \
            -t "manios/nagios:$TAGS-$PLATFORM_DASH" .
          PLATFORM_DASH="linux-arm-v6"
          docker build --platform="linux/arm/v6" \
            --build-arg PLATFORM_DASH="$PLATFORM_DASH" \
            --target "$TAGS" \
            --cache-from="manios/nagios:$TAGS-$PLATFORM_DASH" \
            -t "manios/nagios:$TAGS-$PLATFORM_DASH" .
          PLATFORM_DASH="linux-arm-v7"
          docker build --platform="linux/arm/v6" \
            --build-arg PLATFORM_DASH="$PLATFORM_DASH" \
            --target "$TAGS" \
            --cache-from="manios/nagios:$TAGS-$PLATFORM_DASH" \
            -t "manios/nagios:$TAGS-$PLATFORM_DASH" .
          docker push "manios/nagios:$TAGS-linux-amd64"
          docker push "manios/nagios:$TAGS-linux-arm-v6"
          docker push "manios/nagios:$TAGS-linux-arm-v7"
      - name: Build builder-compile image
        env:
          TAGS: 'builder-compile'      
        run: |
          echo "===================================="
          echo "==== Build stage $TAGS ===="
          echo "===================================="
          docker pull "manios/nagios:$TAGS-linux-amd64" || true
          docker pull "manios/nagios:$TAGS-linux-arm-v6" || true
          docker pull "manios/nagios:$TAGS-linux-arm-v7" || true
          docker run --rm --privileged multiarch/qemu-user-static --reset -p yes
          PLATFORM_DASH="linux-amd64"
          docker build --platform="linux/amd64" \
            --build-arg PLATFORM_DASH="$PLATFORM_DASH" \
            --target "$TAGS" \
            --cache-from="manios/nagios:$TAGS-$PLATFORM_DASH" \
            -t "manios/nagios:$TAGS-$PLATFORM_DASH" .
          PLATFORM_DASH="linux-arm-v6"
          docker build --platform="linux/arm/v6" \
            --build-arg PLATFORM_DASH="$PLATFORM_DASH" \
            --target "$TAGS" \
            --cache-from="manios/nagios:$TAGS-$PLATFORM_DASH" \
            -t "manios/nagios:$TAGS-$PLATFORM_DASH" .
          PLATFORM_DASH="linux-arm-v7"
          docker build --platform="linux/arm/v6" \
            --build-arg PLATFORM_DASH="$PLATFORM_DASH" \
            --target "$TAGS" \
            --cache-from="manios/nagios:$TAGS-$PLATFORM_DASH" \
            -t "manios/nagios:$TAGS-$PLATFORM_DASH" .
          docker push "manios/nagios:$TAGS-linux-amd64"
          docker push "manios/nagios:$TAGS-linux-arm-v6"
          docker push "manios/nagios:$TAGS-linux-arm-v7"
      # - name: Build actual image
      #   run: |
      #     source ./multi-arch-docker-ci.sh
      #     set -ex
      #     multi_arch_docker::printvars
      #     multi_arch_docker::login_to_docker_hub
      #     multi_arch_docker::build_and_push_all
      #     set +x
